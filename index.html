<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµÙˆØªÙŠ</title>

<style>
:root {--main:#2c7be5;--bg:#f4f6f8;--card:#fff;--flash:#d1f5e0;}
body{margin:0;padding:15px;font-family:Arial;background:var(--bg);direction:rtl;text-align:center}
h2{margin-bottom:15px}
button{padding:12px;font-size:16px;border-radius:12px;border:none;margin:5px;cursor:pointer}
.start{background:var(--main);color:#fff}
.stop{background:#dc3545;color:#fff}
canvas{width:100%;height:80px;background:#000;border-radius:12px;margin:10px auto;display:block}
.card{display:flex;justify-content:space-between;background:#fff;padding:10px;margin:5px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:.3s}
.card.flash{background:var(--flash);transform:scale(1.03)}
.count{font-weight:bold;color:var(--main)}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;margin-bottom:5px}
.add-btn{width:100%;padding:10px;border:none;border-radius:10px;background:#28a745;color:white}
</style>
</head>
<body>

<h2>ğŸ¤ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµÙˆØªÙŠ</h2>

<button class="start" id="startBtn">Ø§Ø¨Ø¯Ø£</button>
<button class="stop" id="stopBtn">Ø¥ÙŠÙ‚Ø§Ù</button>

<canvas id="wave"></canvas>

<div id="zikrList"></div>

<div style="margin-top:15px;padding:10px;border:1px solid #ccc;border-radius:12px;">
  <input id="newZikr" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø°ÙƒØ± Ø£Ùˆ Ø§Ù„Ø¯Ø¹Ø§Ø¡">
  <button class="add-btn" id="addBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<p id="heard" style="font-size:14px;color:#555;margin-top:10px;"></p>

<script>
// ========= Ø£Ø¯ÙˆØ§Øª =========
function normalize(t){return t.replace(/[Ù‹ÙŒÙÙÙÙÙ‘Ù’]/g,"").replace(/\s+/g," ").trim();}
function createZikr(text){const words=text.split(" ");const key=words.slice(0,Math.ceil(words.length/2)).join(" ");return { text,key,total:0 };}

// ========= Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =========
let zikrData=[createZikr("Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡"),createZikr("Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡"),createZikr("Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡"),createZikr("Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡")];

// ========= Ø¹Ø±Ø¶ =========
function render(){
  const box=document.getElementById("zikrList"); box.innerHTML="";
  zikrData.forEach((z,i)=>{
    box.innerHTML+=`<div id="card-${i}" class="card"><div>${z.text}</div><div id="count-${i}" class="count">${z.total}</div></div>`;
  });
}
render();

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ù…Ø¹ÙŠÙ†
function renderCount(i){ document.getElementById(`count-${i}`).textContent=zikrData[i].total; }

// ========= Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ± =========
document.getElementById("addBtn").onclick=function(){
  const v=document.getElementById("newZikr").value.trim();
  if(!v) return;
  zikrData.push(createZikr(v)); document.getElementById("newZikr").value=""; render();
}

// ========= Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª =========
let recognition;
function initRecognition(){
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition){ alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª."); return; }
  recognition=new SpeechRecognition();
  recognition.lang="ar-SA";
  recognition.continuous=true;
  recognition.interimResults=true;

  recognition.onresult=function(e){
    for(let i=0;i<e.results.length;i++){
      const result=e.results[i];
      if(!result.isFinal) continue; // âœ… Ø¹Ø¯ ÙÙ‚Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      const text=normalize(result[0].transcript);
      document.getElementById("heard").textContent="Ø³Ù…Ø¹Øª: "+text;

      zikrData.forEach((z,j)=>{
        if(text.includes(z.key)){
          z.total++; flash(j); renderCount(j);
        }
      });
    }
  }

  recognition.onerror=function(err){ console.log("Error:",err); }
}

// ========= ØªÙ†Ø¨ÙŠÙ‡ Ø¨ØµØ±ÙŠ =========
function flash(i){
  const c=document.getElementById(`card-${i}`);
  c.style.background="#d1f5e0"; c.style.transform="scale(1.03)";
  setTimeout(()=>{ c.style.background="#fff"; c.style.transform="scale(1)"; },300);
}

// ========= Ø£Ù…ÙˆØ§Ø¬ ØµÙˆØª =========
let audioCtx, analyser, dataArray, source, stream;
const canvas=document.getElementById("wave"); const ctx=canvas.getContext("2d");
async function startWave(){
  audioCtx=new AudioContext();
  stream=await navigator.mediaDevices.getUserMedia({audio:{noiseSuppression:true,echoCancellation:true,autoGainControl:true}});
  source=audioCtx.createMediaStreamSource(stream);
  analyser=audioCtx.createAnalyser(); analyser.fftSize=2048; dataArray=new Uint8Array(analyser.fftSize); source.connect(analyser); draw();
}
function draw(){requestAnimationFrame(draw); analyser.getByteTimeDomainData(dataArray); ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.strokeStyle="#00ffcc"; ctx.lineWidth=2; ctx.beginPath(); let x=0, slice=canvas.width/dataArray.length; for(let i=0;i<dataArray.length;i++){let y=(dataArray[i]/128)*canvas.height/2; i?ctx.lineTo(x,y):ctx.moveTo(x,y); x+=slice;} ctx.stroke();}

// ========= ØªØ­ÙƒÙ… =========
document.getElementById("startBtn").onclick=()=>{
  initRecognition(); recognition && recognition.start(); startWave();
}
document.getElementById("stopBtn").onclick=()=>{
  recognition && recognition.stop(); stream && stream.getTracks().forEach(t=>t.stop()); audioCtx && audioCtx.close();
}
</script>

</body>
</html>
