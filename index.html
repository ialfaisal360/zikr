<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Whisper Web Ø³Ø±ÙŠØ¹</title>
<style>
body{font-family:Arial;text-align:center;padding:15px;background:#f4f6f8;direction:rtl;}
#progressContainer{width:100%;height:20px;background:#ddd;border-radius:10px;margin:10px 0;}
#progressBar{height:100%;width:0%;background:#2c7be5;border-radius:10px;}
button{padding:12px 18px;font-size:16px;margin:5px;border:none;border-radius:8px;cursor:pointer;}
#start{background:#2c7be5;color:#fff;}
#stop{background:#dc3545;color:#fff;}
canvas{width:100%;height:80px;background:#000;border-radius:8px;margin:10px 0;}
.card{background:#fff;padding:10px;margin:8px 0;border-radius:10px;display:flex;justify-content:space-between;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.card.flash{background:#d1f5e0;transform:scale(1.03);}
.count{font-weight:bold;color:#2c7be5;}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:5px 0;}
.add-btn{width:100%;padding:10px;border:none;border-radius:8px;background:#28a745;color:#fff;}
</style>
</head>
<body>

<h2>ğŸ¤ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Whisper Web Ø³Ø±ÙŠØ¹</h2>

<div id="progressContainer"><div id="progressBar"></div></div>
<p id="status">ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµÙˆØª...</p>

<button id="start" disabled>Ø§Ø¨Ø¯Ø£</button>
<button id="stop" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>

<canvas id="wave"></canvas>

<div id="zikrList"></div>

<input id="newZikr" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø°ÙƒØ± Ø£Ùˆ Ø§Ù„Ø¯Ø¹Ø§Ø¡">
<button class="add-btn" id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ±</button>

<script type="module">
import * as whisperWeb from "./model/whisper-web.min.js"; // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©

// ========== ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Whisper ==========
let model;
const progressBar = document.getElementById("progressBar");
const statusText = document.getElementById("status");

async function loadModel(){
  try{
    model = await whisperWeb.Whisper.loadModel("./model/tiny/",{
      progressCallback:(p)=>{
        progressBar.style.width = Math.floor(p*100) + "%";
        statusText.innerText = "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: " + Math.floor(p*100) + "%";
      }
    });
    statusText.innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ğŸ¤";
    document.getElementById("start").disabled = false;
    document.getElementById("stop").disabled = false;
  }catch(e){
    console.error(e);
    statusText.innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.";
  }
}
loadModel();

// ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø°ÙƒØ§Ø± ==========
let zikrData = [
  { text: "Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡", count:0 },
  { text: "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡", count:0 },
  { text: "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡", count:0 },
  { text: "Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡", count:0 }
];

function renderList(){
  const box = document.getElementById("zikrList");
  box.innerHTML = "";
  zikrData.forEach((z,i)=>{
    box.innerHTML += `<div id="card-${i}" class="card"><span>${z.text}</span><span class="count" id="count-${i}">${z.count}</span></div>`;
  });
}
renderList();

document.getElementById("addBtn").onclick = () => {
  const val = document.getElementById("newZikr").value.trim();
  if(val){ zikrData.push({text:val,count:0}); document.getElementById("newZikr").value=""; renderList();}
};

// ========== Ø£Ù…ÙˆØ§Ø¬ ØµÙˆØª ==========
let audioCtx, analyser, dataArr, source, micStream;
const canvas = document.getElementById("wave");
const ctx = canvas.getContext("2d");

function drawWave(){
  requestAnimationFrame(drawWave);
  if(!analyser) return;
  analyser.getByteTimeDomainData(dataArr);
  ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#00ffcc"; ctx.beginPath();
  let slice = canvas.width/dataArr.length;
  let x=0;
  for(let i=0;i<dataArr.length;i++){
    let y=(dataArr[i]/128)*canvas.height/2;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    x+=slice;
  }
  ctx.stroke();
}

// ========== ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ==========
let isRecording = false;
let audioChunks = [];

document.getElementById("start").onclick = async () => {
  if(!model) return alert("Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù… ÙŠÙƒØªÙ…Ù„ ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯!");
  micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx = new AudioContext();
  source = audioCtx.createMediaStreamSource(micStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  dataArr = new Uint8Array(analyser.fftSize);
  source.connect(analyser);
  drawWave();

  statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
  isRecording = true;
  audioChunks = [];

  const recorder = new MediaRecorder(micStream);
  recorder.ondataavailable = e => audioChunks.push(e.data);
  recorder.start();

  recorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks,{type:"audio/webm"});
    const arrayBuffer = await audioBlob.arrayBuffer();
    const result = await model.transcribe(arrayBuffer);
    const text = result.text.trim();
    statusText.innerText = "Ø³Ù…Ø¹Øª: "+text;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    zikrData.forEach((z,i)=>{
      const regex = new RegExp("\\b" + z.text.replace(/[.*+?^${}()|[\\]\/]/g,"\\\\$&") + "\\b","gi");
      const matches = text.match(regex);
      if(matches){
        z.count += matches.length;
        document.getElementById(`count-${i}`).innerText = z.count;
        document.getElementById(`card-${i}`).classList.add("flash");
        setTimeout(()=>document.getElementById(`card-${i}`).classList.remove("flash"),300);
      }
    });
  };

  setTimeout(()=>recorder.stop(),3000); // ØªØ³Ø¬ÙŠÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
};

document.getElementById("stop").onclick = () => {
  if(micStream){
    micStream.getTracks().forEach(t=>t.stop());
    audioCtx && audioCtx.close();
    statusText.innerText = "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù";
  }
};
</script>
</body>
</html>
